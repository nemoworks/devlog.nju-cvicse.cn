<!DOCTYPE html>
<html lang="cn">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">



<title>开发文档 | 开发日志</title>



    <link rel="icon" href="https://nemoworks.s3.cn-north-1.jdcloud-oss.com/dev.nju-cvicse.cn/images/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="https://nemoworks.s3.cn-north-1.jdcloud-oss.com/dev.nju-cvicse.cn/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="https://nemoworks.s3.cn-north-1.jdcloud-oss.com/dev.nju-cvicse.cn/js/script.js"></script>
    
    <script src="https://nemoworks.s3.cn-north-1.jdcloud-oss.com/dev.nju-cvicse.cn/js/tocbot.min.js"></script>
    



    
    
        
    


</head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">开发日志</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/categories/Leasing">租赁</a>
                
                    <a class="menu-item" href="/categories/Others">其他</a>
                
                    <a class="menu-item" href="/about">关于</a>
                
            </div>

        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">开发日志</a><a id="mobile-toggle-theme"></a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/categories/Leasing">租赁</a>
                
                    <a class="menu-item" href="/categories/Others">其他</a>
                
                    <a class="menu-item" href="/about">关于</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">开发文档</h1>
            
                <div class="post-meta">
                    

                    
                        <span class="post-time">
                        Date: <a href="#">September 25, 2019&nbsp;&nbsp;23:36:15</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/categories/Leasing/">Leasing</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h3 id="总体架构"><a href="#总体架构" class="headerlink" title="总体架构"></a>总体架构</h3><p>本项目旨在实现一个可在线处理租赁业务的原型系统，其特点在于合同的在线编辑，业务中涉及所有数据对象的高度可配置以及配置过程的零编码。为了实现这个特点，我们设计了不同于传统Web项目的开发模式。</p>
<img src="http://cdn.nemoworks.info/devlog.nju-cvicse.cn/images/devpattern.png">

<p>传统的开发模式通过代码实现数据对象的类定义并基于关系型数据库进行管理，在这种模式下，数据对象在运行时是无法修改的，因此难以实现数据对象的高度可配置。本开发模式下，通过模式管理工具来实现数据对象的定义，通过一个模式来描述一个数据对象的格式，并通过一个非结构化的文档来存储数据对象。</p>
<p>模式是对一个数据对象的定义。它可以类比为传统模式下的java代码类定义，描述了一类数据对象应该具有的数据和数据类型定义以及该数据对象与其他数据对象的关联关系。但与java代码的类定义不同，模式本身也是运行时可管理的数据，而不是运行时无法更改的代码或配置文件。由此，用户可以在运行时完全通过前端对数据对象进行定义，而无需通过编码的方式来定义一类数据对象，从而实现数据对象的高度可配置和配置过程的零编码。在本项目中，我们将数据对象以JSON对象的形式存储，并采用JSON-schema作为数据对象的模式，定义一类数据对象。</p>
<p>由于模式本身是可以在运行时进行管理的数据，因此它可以通过前端进行创建，修改，删除和查询。前端可以通过接入模式管理工具来实现模式的可视化定义。在本项目中，我们用JSON-schema作为数据对象的模式，并用React作为前端基础框架，因此我们采用React架构的JSON-schema-editor组件作为模式管理工具。</p>
<h3 id="schema管理"><a href="#schema管理" class="headerlink" title="schema管理"></a>schema管理</h3><h4 id="创建schema"><a href="#创建schema" class="headerlink" title="创建schema"></a>创建schema</h4><ul>
<li>数据说明（schema数据说明，注意说明schema引用关系）</li>
</ul>
<p>Json Schema定义了一套词汇和规则，用来定义Json元数据。这些元数据定义给出了Json数据需要满足的各项规范（成员、结构、类型等）。</p>
<p>以一个合同的schema框架为例，可能的设计如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"title"</span>: <span class="string">"Contract_Schema_1"</span>,</span><br><span class="line">  <span class="attr">"description"</span>: <span class="string">"A Sample of Contract Schema"</span>,</span><br><span class="line">  <span class="attr">"type"</span>: <span class="string">"object"</span>,</span><br><span class="line">  </span><br><span class="line">  <span class="attr">"properties"</span>: &#123;</span><br><span class="line">    <span class="attr">"linkList"</span>: &#123;</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"array"</span>,</span><br><span class="line">      <span class="attr">"items"</span>: &#123;</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"link"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,//linkList存储一系列编号，包括客户编号、资金流编号等，作外键使用</span><br><span class="line">    "leases": &#123;</span><br><span class="line">      "type": "array",</span><br><span class="line">      "items": &#123;</span><br><span class="line">        "type": "leaseType"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,//待租物品，定制类型leaseType</span><br><span class="line">    "startDate": &#123;"type": "date"&#125;,</span><br><span class="line">    "endDate": &#123;"type": "date"&#125;//租赁起止日期，类型为date</span><br><span class="line">    //...可按需求添加其余字段及类型</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以一个客户的schema为例，可能的设计如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"title"</span>: <span class="string">"Customer_Schema_1"</span>,</span><br><span class="line">  <span class="attr">"description"</span>: <span class="string">"A Sample of Customer Schema"</span>,</span><br><span class="line">  <span class="attr">"type"</span>: <span class="string">"object"</span>,</span><br><span class="line">  </span><br><span class="line">  <span class="attr">"properties"</span>: &#123;</span><br><span class="line">    <span class="attr">"id"</span>: &#123;<span class="attr">"type"</span>: <span class="string">"string"</span>&#125;,</span><br><span class="line">    <span class="attr">"name"</span>: &#123;<span class="attr">"type"</span>: <span class="string">"string"</span>&#125;,</span><br><span class="line">    //...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>二者之间的关系可由如下类图表示：</p>
<img src="http://cdn.nemoworks.info/devlog.nju-cvicse.cn/images/customer_contract.png">

<ul>
<li>扩展定义</li>
</ul>
<p>通过Json Schema Definitions定制若干种数据类型</p>
<p>以上述合同的schema为例，根据客户所需待租物品的不同，可以设计自定义类型leaseType，指定待租物品的种类、数量、大小等属性</p>
<p>也可对应租赁起止日期设计类型：date，通过设置format来使其符合日期定义</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"definitions"</span>: &#123;</span><br><span class="line">    //...</span><br><span class="line">    "link": &#123;</span><br><span class="line">      "type": "link",</span><br><span class="line">      "customized": "link"</span><br><span class="line">    &#125;,</span><br><span class="line">    "leaseType": &#123;</span><br><span class="line">      "type": "object",</span><br><span class="line">      "customized": "leaseType",</span><br><span class="line">      "properties": &#123;</span><br><span class="line">        "kind": &#123; "type": &#123; "enum": ["ship", "truck"]&#125;&#125;,</span><br><span class="line">        "amount": &#123;"type": "number"&#125;,</span><br><span class="line">        "size": &#123; "type": &#123; "enum": ["little", "medium", "large"]&#125;&#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      "required": ["kind", "amount", "size"]</span><br><span class="line">    &#125;,</span><br><span class="line">    "date": &#123;</span><br><span class="line">      "type": "string",</span><br><span class="line">      "customized": "date",</span><br><span class="line">      "format": "date"</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中link属于一项关联属性，用以实现级联查询操作（如从contract的schema中获取到对应的客户信息）</p>
<p>link的content可以是一整个文档，也可以是一个表示uri的字符串链接（如collection1/B表示从collection1中选取到B文档），后台通过检索该链接获取到对应的文档信息</p>
<p>使用时可参照如下格式：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"link"</span>: &#123;</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"link"</span>,</span><br><span class="line">    <span class="attr">"discription"</span>: <span class="string">"..."</span>,</span><br><span class="line">    "method": &#123; "enum": &#123; ["value", "address"] &#125; &#125;,</span><br><span class="line">    "content": //链接或者文档</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一个具体的多层级联查询所用到的link如下（以存在的A、B、C三个文档为例，在A文档中写下如下linkA，在B文档中写下linkB，可通过向后端传字符串A.linkA.linkB来访问到文档C，此处的字符串格式可自定义，由后台的处理方法决定）：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;//A.linkList.linkA</span><br><span class="line">  "link": &#123;</span><br><span class="line">    "type": "link",</span><br><span class="line">    "name": "linkA",</span><br><span class="line">    "discription": "link to B by address"</span><br><span class="line">    "method": "address",</span><br><span class="line">    "content": "collection1/B"</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;//B.linkList.linkB</span><br><span class="line">  "link": &#123;</span><br><span class="line">   	"type": "link",</span><br><span class="line">    "name": "linkB",</span><br><span class="line">    "discription": "link to C by value",</span><br><span class="line">    "method": "value",</span><br><span class="line">    "content": C 	//代表文档C的字符串</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>前端界面（schema editor部分）</li>
</ul>
<p>Schema editor直接使用我们打包好的组件，包含以下三个可选参数</p>
<ul>
<li>data：当前schema的源文本</li>
<li>onChange：editor更改事件处理方法 注：暂时不支持onChange方法中调用setState** </li>
<li>extensions：各个definition的定义</li>
</ul>
<p>以上述合同schema为例，definitions的定义有如下几步：</p>
<ol>
<li>选取一个类型（下例中为link）写成js文件</li>
</ol>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// '@/components/Link/schema.js'</span></span><br><span class="line"><span class="keyword">const</span> linkDef = &#123;</span><br><span class="line">    <span class="string">"link"</span>: &#123;</span><br><span class="line">        <span class="string">"customized"</span>: <span class="string">"link"</span>,</span><br><span class="line">        <span class="string">"type"</span>: <span class="string">"link"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>为该类型添加定制组件，即advacned settings，这部分在下面一小节作出说明</li>
</ol>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// '@/components/Link/template.js'</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CustomizedSchemaLink</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>为该类型添加定制渲染方式，即Form表单的显示样式，这部分在documents中给予说明</li>
</ol>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// '@/components/Link/field.js'</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">LinkField</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line"> 		<span class="comment">// ... </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>将上述三个文件中的定义合并为一个extension条目</li>
</ol>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// '@/components/Link/index.js'</span></span><br><span class="line"><span class="keyword">import</span> field <span class="keyword">from</span> <span class="string">'./field'</span></span><br><span class="line"><span class="keyword">import</span> template <span class="keyword">from</span> <span class="string">'./template'</span></span><br><span class="line"><span class="keyword">import</span> schema <span class="keyword">from</span> <span class="string">'./schema'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    field,</span><br><span class="line">    template,</span><br><span class="line">    schema</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>对所有类型都执行上述操作，最后合并所有类型成为一个综合的definitions</li>
</ol>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> date <span class="keyword">from</span> <span class="string">'@/components/Date/index'</span></span><br><span class="line"><span class="keyword">import</span> leaseType <span class="keyword">from</span> <span class="string">'@/components/LeaseType/index'</span></span><br><span class="line"><span class="keyword">import</span> link <span class="keyword">from</span> <span class="string">'@/components/Link/index'</span></span><br><span class="line"><span class="keyword">const</span> extensions = &#123;</span><br><span class="line">    date,</span><br><span class="line">    leaseType,</span><br><span class="line">    link</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用户可以通过schema editor来构建合同的schema，这个schema在用户建立表单form时可供选择</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> SchemaEditor <span class="keyword">from</span> <span class="string">'json-schema-editor-visual-lab'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> definitions = &#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="comment">//...</span></span><br><span class="line">      &lt;SchemaEditor data = &#123;<span class="keyword">this</span>.state.schema&#125;</span><br><span class="line">        onChange = &#123;schema =&gt; <span class="built_in">console</span>.log(schema)&#125;</span><br><span class="line">        extensions = &#123;definitions&#125;</span><br><span class="line">        /&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用schema editor构建上述contract schema，如下例：</p>
<img src="http://cdn.nemoworks.info/devlog.nju-cvicse.cn/images/schema_editor.png">

<p>示例代码：</p>
<p><a href="https://github.com/nemoworks/sddm-frontend" target="_blank" rel="noopener">前端示例</a></p>
<ul>
<li>高级组件（advanced setting部分）</li>
</ul>
<p>用户构建schema时，实际上是通过将各种组件拼合在一起的方式来创建的</p>
<p>高级组件使得用户可以对其中的特殊类型进行扩展</p>
<p>定制某种类型的advanced settings，实际上是实现一个自行定制的组件，然后通过defintions的component属性传入editor，使得该advanced settings与自己的对应特殊类型相关联</p>
<p>在打包好的schema editor内部，会检查当前传入的definitions是否在内置的基础类型上有扩展，若有则会采用传入的参数对类型列表进行更新，并使用对应的advanced settings</p>
<p>原有类型Map：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> mapping = <span class="function"><span class="params">data</span> =&gt;</span> (&#123;</span><br><span class="line">  string: &lt;CustomizedSchemaString data=&#123;data&#125; /&gt;,</span><br><span class="line">  number: &lt;CustomizedSchemaNumber data=&#123;data&#125; /&gt;,</span><br><span class="line">  boolean: &lt;CustomizedSchemaBoolean data=&#123;data&#125; /&gt;,</span><br><span class="line">  integer: &lt;CustomizedSchemaNumber data=&#123;data&#125; /&gt;,</span><br><span class="line">  array: &lt;CustomizedSchemaArray data=&#123;data&#125; /&gt;,</span><br><span class="line">  object: &lt;CustomizedSchemaObject data=&#123;data&#125; /&gt;,</span><br><span class="line">&#125;[data.type]);</span><br></pre></td></tr></table></figure>

<p>当传入definitions之后，该Map有如下更新：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> mapping = <span class="function"><span class="params">data</span> =&gt;</span> (&#123;</span><br><span class="line">  <span class="comment">//...(原有类型)</span></span><br><span class="line">  link: &lt;CustomizedSchemaLink data=&#123;data&#125; /&gt;,</span><br><span class="line">  leaseType: &lt;CustomizedSchemaLeaseType data=&#123;data&#125; /&gt;,</span><br><span class="line">  date: &lt;CustomizedSchemaDate data=&#123;data&#125; /&gt;,</span><br><span class="line">&#125;[data.type]);</span><br></pre></td></tr></table></figure>

<p>由此组件实现了不同类型的定制及高级配置</p>
<p>Advanced settings中的props包含的data与context两个参数，其中data表示该块schema，context是上下文，可提供将当前所填内容写回整个schema的功能</p>
<p>如下是对link类型的高级设置的定制：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* @/components/JsonSchema/components/SchemaComponents/SchemaLink.js */</span></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123; Cascader, Row, Col, Input, Button &#125; <span class="keyword">from</span> <span class="string">'antd'</span></span><br><span class="line"><span class="keyword">import</span> PropTypes <span class="keyword">from</span> <span class="string">'prop-types'</span>;</span><br><span class="line"><span class="keyword">import</span> LocalProvider <span class="keyword">from</span> <span class="string">'../LocalProvider/index.js'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; connect &#125; <span class="keyword">from</span> <span class="string">'dva'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mapStateToProps = <span class="function"><span class="params">state</span> =&gt;</span> (&#123;</span><br><span class="line">  link: state[<span class="string">'jsonSchema-link'</span>]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CustomizedSchemaLink</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; data, dispatch &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.state.options)</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;div className=<span class="string">"default-setting"</span>&gt;&#123;LocalProvider(<span class="string">'base_setting'</span>)&#125;&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">        &lt;Row className="other-row" type="flex" align="middle"&gt;</span></span><br><span class="line"><span class="regexp">          &lt;Col span=&#123;4&#125; className="other-label"&gt;</span></span><br><span class="line"><span class="regexp">            &#123;LocalProvider('link')&#125;：</span></span><br><span class="line"><span class="regexp">          &lt;/</span>Col&gt;</span><br><span class="line">          &lt;Col span=&#123;<span class="number">20</span>&#125;&gt;</span><br><span class="line">            <span class="comment">/* link类型advanced settings组件的核心是一个级联选择框 */</span></span><br><span class="line">            &lt;Cascader placeholder=<span class="string">"please select customer schema and document"</span> style=&#123;&#123; <span class="attr">width</span>: <span class="string">'100%'</span> &#125;&#125;</span><br><span class="line">              options=&#123;<span class="keyword">this</span>.state.options&#125;<span class="comment">//动态选项</span></span><br><span class="line">              onChange=&#123;selectedOptions =&gt; &#123;</span><br><span class="line">                <span class="comment">/* 将选中的key和val写回当前的schema中 */</span></span><br><span class="line">                <span class="built_in">console</span>.log(selectedOptions)</span><br><span class="line">                <span class="keyword">this</span>.changeOtherValue(selectedOptions[<span class="number">0</span>], <span class="string">"key"</span>, data)</span><br><span class="line">                <span class="keyword">this</span>.changeOtherValue(selectedOptions[<span class="number">2</span>], <span class="string">"val"</span>, data)</span><br><span class="line">              &#125;&#125; loadData=&#123;<span class="keyword">this</span>.loadData&#125; changeOnSelect &gt;</span><br><span class="line">            &lt;<span class="regexp">/Cascader&gt;</span></span><br><span class="line"><span class="regexp">          &lt;/</span>Col&gt;</span><br><span class="line">        &lt;<span class="regexp">/Row&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>div&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  state = &#123;</span><br><span class="line">    options: []</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 回写schema方法 */</span></span><br><span class="line">  changeOtherValue = <span class="function">(<span class="params">value, name, data</span>) =&gt;</span> &#123;</span><br><span class="line">    data[name] = value;</span><br><span class="line">    <span class="keyword">this</span>.context.changeCustomValue(data);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">	componentDidMount() &#123;</span><br><span class="line">    <span class="comment">/* 渲染第一层可选项 */</span></span><br><span class="line">    <span class="keyword">this</span>.props.dispatch(&#123;</span><br><span class="line">      type: <span class="string">'jsonSchema-link/getCollectionList'</span>,</span><br><span class="line">      callback: <span class="function"><span class="params">collectionList</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> options = collectionList.map(<span class="function"><span class="params">item</span> =&gt;</span> (&#123; <span class="attr">value</span>: item, <span class="attr">label</span>: item, <span class="attr">isLeaf</span>: <span class="literal">false</span> &#125;))</span><br><span class="line">        <span class="keyword">this</span>.setState(&#123; options &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 级联选择动态加载数据 */</span></span><br><span class="line">  loadData = <span class="function"><span class="params">selectedOptions</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">/* 渲染第二层可选项，向后台请求符合要求的所有schema */</span></span><br><span class="line">    <span class="keyword">if</span> (selectedOptions.length === <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> targetOption = selectedOptions[selectedOptions.length - <span class="number">1</span>];</span><br><span class="line">      targetOption.loading = <span class="literal">true</span>;</span><br><span class="line">      <span class="comment">/* 向后台请求collection为key的schema */</span></span><br><span class="line">      <span class="keyword">this</span>.props.dispatch(&#123;</span><br><span class="line">        type: <span class="string">'jsonSchema-link/getSchemaList'</span>,</span><br><span class="line">        key: targetOption.value,</span><br><span class="line">        callback: <span class="function"><span class="params">schemaList</span> =&gt;</span> &#123;</span><br><span class="line">          targetOption.loading = <span class="literal">false</span>;</span><br><span class="line">          targetOption.children = schemaList.map(<span class="function"><span class="params">item</span> =&gt;</span> (&#123; <span class="attr">value</span>: item.id, <span class="attr">label</span>: item.name, <span class="attr">isLeaf</span>: <span class="literal">false</span> &#125;))</span><br><span class="line">          <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">            options: [...this.state.options],</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* 渲染第三层可选项，向后台请求符合要求的所有document */</span></span><br><span class="line">    <span class="keyword">if</span> (selectedOptions.length === <span class="number">2</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> targetOption = selectedOptions[selectedOptions.length - <span class="number">1</span>];</span><br><span class="line">      targetOption.loading = <span class="literal">true</span>;</span><br><span class="line">      <span class="comment">/* 根据选中的schemaId向后台请求相关的document */</span></span><br><span class="line">      <span class="keyword">this</span>.props.dispatch(&#123;</span><br><span class="line">        type: <span class="string">'jsonSchema-link/getDocumentListBySchemaId'</span>,</span><br><span class="line">        id: targetOption.value,</span><br><span class="line">        callback: <span class="function"><span class="params">documentList</span> =&gt;</span> &#123;</span><br><span class="line">          targetOption.loading = <span class="literal">false</span>;</span><br><span class="line">          targetOption.children = documentList.map(<span class="function"><span class="params">item</span> =&gt;</span> (&#123; <span class="attr">value</span>: item.id, <span class="attr">label</span>: item.name &#125;))</span><br><span class="line">          <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">            options: [...this.state.options],</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line">CustomizedSchemaLink.contextTypes = &#123;</span><br><span class="line">  changeCustomValue: PropTypes.func,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> connect(mapStateToProps)(CustomizedSchemaLink)</span><br></pre></td></tr></table></figure>

<p>下图以link为例展示了advanced settings的效果：</p>
<img src="http://cdn.nemoworks.info/devlog.nju-cvicse.cn/images/link_advancedsettings_select.png">

<p>选择好对应的document后的效果：</p>
<img src="http://cdn.nemoworks.info/devlog.nju-cvicse.cn/images/link_advancedsettings_selected.png">



<ul>
<li>后台接口（schema管理接口）</li>
</ul>
<p>首先对schema类进行说明：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Document</span>(collection = <span class="string">"Schema"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Schema</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Id</span></span><br><span class="line">  <span class="keyword">private</span> String id;<span class="comment">//作为数据库主键</span></span><br><span class="line">  <span class="keyword">private</span> JSONObject schemaContent;<span class="comment">//包含了schema中的所有内容</span></span><br><span class="line">  <span class="keyword">private</span> Status status;<span class="comment">//指示位，表示当前schema的状态</span></span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span>  Status &#123;</span><br><span class="line">  Created, Deleted;<span class="comment">//两个值分别对应创建和删除</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建schema，并设定status为Created（即创建）：</p>
<p>service层接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Schema <span class="title">createSchema</span><span class="params">(JSONObject content)</span></span>&#123;</span><br><span class="line">  logger.info(<span class="string">"create schema."</span>);</span><br><span class="line">  Schema schema = <span class="keyword">new</span> Schema(content);</span><br><span class="line">  schema.setStatus(Status.Created);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.schemaRepository.save(schema);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>controller层接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Schema <span class="title">createSchema</span><span class="params">(@RequestBody JSONObject params)</span></span>&#123;</span><br><span class="line">  logger.info(<span class="string">"create new Schema. "</span>);</span><br><span class="line">  <span class="keyword">return</span> schemaService.createSchema(params);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>版本维护实现基于JaVers，JaVers是一个轻量级，完全开源的Java库，用于追踪和记录数据中的更改。它可以配合repository使用，只需要添加一行注解<code>@JaversSpringDataAuditable</code>即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="meta">@JaversSpringDataAuditable</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SchemaRepository</span> <span class="keyword">extends</span> <span class="title">MongoRepository</span>&lt;<span class="title">Schema</span>,<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">  <span class="function">List&lt;Schema&gt; <span class="title">findAllByStatus</span><span class="params">(Status status)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当数据库中有数据发生修改时，JaVers会自动追踪和记录数据库中发生的修改，存为特定数据类型Snapshot，在获取时可以通过版本号来访问到某次修改过后的数据内容</p>
<p>在创建schema时，JaVers会对应生成初始版本记录，记录效果如下图：</p>
<img src="http://cdn.nemoworks.info/devlog.nju-cvicse.cn/images/schema_javers.png">

<h4 id="删除schema"><a href="#删除schema" class="headerlink" title="删除schema"></a>删除schema</h4><p>删除作为一种标记操作，而不是真的从数据库中将schema删除</p>
<p>若直接将schema删除，在之后就无法实现从对应生成的合同中查看该schema等相关操作</p>
<p>实现方式为修改schema的status属性为Deleted</p>
<p>接口名称及实现：</p>
<p>service层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteSchema</span><span class="params">(String id)</span></span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.schemaRepository.findById(id).ifPresent(schema -&gt; &#123;</span><br><span class="line">    schema.setStatus(Status.Deleted);</span><br><span class="line">    <span class="keyword">this</span>.schemaRepository.save(schema);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>controller层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Schema&gt; <span class="title">deleteSchema</span><span class="params">(@PathVariable String id)</span></span>&#123;</span><br><span class="line">  logger.info(<span class="string">"delete schema "</span>+id);</span><br><span class="line">  schemaService.deleteSchema(id);</span><br><span class="line">  <span class="keyword">return</span> schemaService.getAllSchemas();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="更新schema"><a href="#更新schema" class="headerlink" title="更新schema"></a>更新schema</h4><p>接口名称及实现:</p>
<p>service层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Schema <span class="title">updateSchema</span><span class="params">(String id,JSONObject jsonObject)</span> </span>&#123;</span><br><span class="line">  logger.info(<span class="string">"update schema by id."</span>);</span><br><span class="line">  <span class="keyword">this</span>.schemaRepository.findById(id).ifPresent(schema -&gt; &#123;</span><br><span class="line">    schema.setSchema(jsonObject);</span><br><span class="line">    <span class="keyword">this</span>.schemaRepository.save(schema);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.schemaRepository.findById(id).get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>controller层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Schema <span class="title">updateSchema</span><span class="params">(@PathVariable String id,@RequestBody JSONObject params)</span></span>&#123;</span><br><span class="line">  logger.info(<span class="string">"update schema by Id "</span>+ id);</span><br><span class="line">  <span class="keyword">return</span> schemaService.updateSchema(id,params);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时的更新操作会被JaVers识别，记录到版本历史中</p>
<h4 id="查询schema（后台接口）"><a href="#查询schema（后台接口）" class="headerlink" title="查询schema（后台接口）"></a>查询schema（后台接口）</h4><p>获取所有未被删除的schema：</p>
<p>service层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Schema&gt; <span class="title">getAllSchemas</span><span class="params">()</span></span>&#123;</span><br><span class="line">  logger.info(<span class="string">"get all schemas"</span>);</span><br><span class="line">  <span class="keyword">return</span> schemaRepository.findAllByStatus(Status.Created);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>controller层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Schema&gt; <span class="title">getSchemas</span><span class="params">()</span></span>&#123;</span><br><span class="line">  logger.info(<span class="string">"get all schemas"</span>);</span><br><span class="line">  <span class="keyword">return</span> schemaService.getAllSchemas();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据id获取对应schema：</p>
<p>service层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Schema <span class="title">getSchemaById</span><span class="params">(String id)</span></span>&#123;</span><br><span class="line">  logger.info(<span class="string">"get schema by id"</span>);</span><br><span class="line">  Schema schema = schemaRepository.findById(id).get();</span><br><span class="line">  <span class="keyword">if</span>(schema.getStatus().equals(Status.Created))&#123;</span><br><span class="line">    <span class="keyword">return</span> schemaRepository.findById(id).get();</span><br><span class="line">  &#125;<span class="keyword">else</span> <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>controller层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Schema <span class="title">getSchemaById</span><span class="params">(@PathVariable String id)</span></span>&#123;</span><br><span class="line">  logger.info(<span class="string">"get schema by id "</span>+id);</span><br><span class="line">  <span class="keyword">return</span> schemaService.getSchemaById(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据schemaId和javers记录的提交编号检索对应schema的历史版本：</p>
<p>service层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Schema <span class="title">getSchemaWithJaversCommitId</span><span class="params">(String schemaId, String commitId)</span> <span class="keyword">throws</span> SchemaNotFoundException</span>&#123;</span><br><span class="line">  Schema schema = <span class="keyword">this</span>.getSchema(schemaId);</span><br><span class="line">  JqlQuery jqlQuery= QueryBuilder.byInstance(schema).build();</span><br><span class="line">  List&lt;CdoSnapshot&gt; snapshots = javers.findSnapshots(jqlQuery);</span><br><span class="line">  <span class="keyword">for</span>(CdoSnapshot snapshot:snapshots)&#123;</span><br><span class="line">    <span class="keyword">if</span>(snapshot.getCommitId().getMajorId()== Integer.parseInt(commitId))</span><br><span class="line">      <span class="keyword">return</span> JSON.parseObject(javers.getJsonConverter().toJson(snapshot.getState()),Schema.class);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>controller层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> JSONArray <span class="title">getSchemaWithCommitId</span><span class="params">(@PathVariable String id, @RequestParam(value = <span class="string">"commitId"</span>, defaultValue = <span class="string">"null"</span>)</span> String commitId) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (commitId.equals(<span class="string">"null"</span>)) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      logger.info(<span class="string">"Get Schema commits with schemaId "</span>+ id);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.schemaService.trackSchemaChangesWithJavers(id);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ResponseStatusException(HttpStatus.NOT_FOUND, <span class="string">"Schema Not Found."</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      logger.info(<span class="string">"Cet Schema commit with schemaId and commitId"</span> + commitId);</span><br><span class="line">      JSONArray jsonArray = <span class="keyword">new</span> JSONArray();</span><br><span class="line">      jsonArray.add(<span class="keyword">this</span>.schemaService.getSchemaWithJaversCommitId(id, commitId));</span><br><span class="line">      <span class="keyword">return</span> jsonArray;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ResponseStatusException(HttpStatus.NOT_FOUND, <span class="string">"Schema Not Found."</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="document管理"><a href="#document管理" class="headerlink" title="document管理"></a>document管理</h3><h4 id="创建document（从schema创建document）"><a href="#创建document（从schema创建document）" class="headerlink" title="创建document（从schema创建document）"></a>创建document（从schema创建document）</h4><ul>
<li>数据说明（document数据说明）</li>
</ul>
<p>以上文中第一个创建的合同schema为例，schema与对应数据组合成为document，一个合同的document如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"linkList"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"link"</span>: <span class="string">"customer"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">    	<span class="attr">"link"</span>: <span class="string">"cashflow"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"link"</span>: <span class="string">"lease"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"leases"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"kind"</span>: <span class="string">"ship"</span>,</span><br><span class="line">      <span class="attr">"amount"</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">"size"</span>: <span class="string">"medium"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"startDate"</span>: <span class="string">"2019-02-02"</span>,</span><br><span class="line">  <span class="attr">"endDate"</span>: <span class="string">"2019-06-09"</span>,</span><br><span class="line">  //...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>前端界面（document editor部分）</li>
</ul>
<img src="http://cdn.nemoworks.info/devlog.nju-cvicse.cn/images/select_schema.png">

<p>以合同为例，用户从合同schema生成document需要以下几步</p>
<ol>
<li>通过选择模板选择对应schema</li>
<li>使用该schema生成form，供用户填写数据</li>
<li>获取用户填写的数据，生成对应document</li>
</ol>
<p>一个创建好的form表单如下：</p>
<img src="http://cdn.nemoworks.info/devlog.nju-cvicse.cn/images/form_editor.png">

<ul>
<li>高级组件（advanced component部分）</li>
</ul>
<p>针对不同的待填项，可以设置其属性（包括填写类型，填写方式，对所填项的各种要求等）对应这些项在表单中的渲染方式，这些组件均由用户自定义，构成最终需要生成的表单</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> date <span class="keyword">from</span> <span class="string">'@/components/Date/index'</span></span><br><span class="line"><span class="keyword">import</span> leaseType <span class="keyword">from</span> <span class="string">'@/components/LeaseType/index'</span></span><br><span class="line"><span class="keyword">import</span> link <span class="keyword">from</span> <span class="string">'@/components/Link/index'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> extensionsForm = &#123;</span><br><span class="line">    date: date.field,</span><br><span class="line">    leaseType: leaseType.field,</span><br><span class="line">    link: link.field</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">render() &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    &lt;Form schema=&#123;<span class="built_in">JSON</span>.parse(<span class="keyword">this</span>.state.schema)&#125;</span><br><span class="line">      extensions=&#123;extensionsForm&#125;</span><br><span class="line">      /&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以渲染link类型对应的组件LinkField为例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* @/components/JsonSchemaForm/components/fields/LinkField.js */</span></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123; connect &#125; <span class="keyword">from</span> <span class="string">'dva'</span></span><br><span class="line"><span class="keyword">import</span> &#123; Button, Checkbox, Select &#125; <span class="keyword">from</span> <span class="string">'antd'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mapStateToProps = <span class="function"><span class="params">state</span> =&gt;</span> (&#123;</span><br><span class="line">    link: state[<span class="string">'jsonSchemaForm-link'</span>]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LinkField</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; label, schema, link &#125; = <span class="keyword">this</span>.props</span><br><span class="line">        <span class="keyword">const</span> selectList = link.content.map(<span class="function"><span class="params">item</span> =&gt;</span> &lt;Select.Option value=&#123;item&#125;&gt;&#123;item&#125;&lt;/Select.Option&gt;)</span><br><span class="line">        <span class="keyword">debugger</span></span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;div&gt;</span><br><span class="line">                &lt;label&gt;&#123;label&#125;&lt;<span class="regexp">/label&gt;</span></span><br><span class="line"><span class="regexp">          			/</span>* LinkField组件的核心是一个下拉选择框，可选项根据向后台请求得到的<span class="built_in">document</span>渲染 *<span class="regexp">/</span></span><br><span class="line"><span class="regexp">                &lt;Select defaultValue=&#123;this.props.formData&#125; style=&#123;&#123; width: 120 &#125;&#125; onChange=&#123;value =&gt; this.props.onChange(value)&#125;&gt;</span></span><br><span class="line"><span class="regexp">                    &#123;selectList&#125;</span></span><br><span class="line"><span class="regexp">                &lt;/</span>Select&gt;</span><br><span class="line">            &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">        )</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">    state = &#123;</span></span><br><span class="line"><span class="regexp">        selected: this.props.formData,</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">    componentDidMount() &#123;</span></span><br><span class="line"><span class="regexp">     	 	/</span>* 根据schema中的key和val，向后台请求对应的<span class="built_in">document</span> *<span class="regexp">/</span></span><br><span class="line"><span class="regexp">        this.props.dispatch(&#123;</span></span><br><span class="line"><span class="regexp">            type: 'jsonSchemaForm-link/g</span>etDocument<span class="string">',</span></span><br><span class="line"><span class="string">            key: this.props.schema.key,</span></span><br><span class="line"><span class="string">            val: this.props.schema.val,</span></span><br><span class="line"><span class="string">        &#125;)</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">export default connect(mapStateToProps)(LinkField)</span></span><br></pre></td></tr></table></figure>

<ul>
<li>后台接口（document管理接口）</li>
</ul>
<p>首先对document类进行说明：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@org</span>.springframework.data.mongodb.core.mapping.Document(collection = <span class="string">"Document"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Document</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Id</span></span><br><span class="line">  <span class="keyword">private</span> String id;<span class="comment">//数据库主键</span></span><br><span class="line">  <span class="keyword">private</span> String schemaId;<span class="comment">//对应的schema的编号</span></span><br><span class="line">  <span class="keyword">private</span> String collectionName;<span class="comment">//属于什么类型的文档，如客户、合同等</span></span><br><span class="line">  <span class="keyword">private</span> JSONObject data;<span class="comment">//用户填写的json数据</span></span><br><span class="line">  <span class="keyword">private</span> Status status;<span class="comment">//同schema中的status，表示是否删除</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建document，实现方式为从某个版本、某个类型的schema创建，接口如下：</p>
<p>service层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Document <span class="title">createNewDocument</span><span class="params">(String schemaId,JSONObject content&#123;</span></span></span><br><span class="line"><span class="function"><span class="params">  logger.info(<span class="string">"create new document by schemaId "</span>+schemaId)</span></span>;</span><br><span class="line">  Document document = <span class="keyword">new</span> Document();</span><br><span class="line">  document.setSchemaId(schemaId);</span><br><span class="line">  document.setData(content);</span><br><span class="line">  document.setStatus(Status.Created);</span><br><span class="line">  document.setCollectionName(content.getString(<span class="string">"title"</span>));</span><br><span class="line">  documentRepository.save(document);</span><br><span class="line">  <span class="keyword">return</span> mongoTemplate.insert(document,document.getCollectionName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>controller层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Document <span class="title">createDocument</span><span class="params">(@RequestBody JSONObject params, @RequestParam(value = <span class="string">"schemaId"</span>,defaultValue = <span class="string">"null"</span>)</span> String schemaId, @<span class="title">RequestParam</span><span class="params">(value = <span class="string">"collectionName"</span>,defaultValue = <span class="string">"null"</span>)</span> String collectionName)</span>&#123;</span><br><span class="line">  logger.info(<span class="string">"create new Document by SchemaId "</span>+schemaId+<span class="string">" and collectionName "</span>+collectionName);</span><br><span class="line">  <span class="keyword">return</span> documentService.createNewDocument(schemaId,params);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>版本维护同样通过JaVers实现，使用JaVers定义repository后，JaVers会自动监听数据修改：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="meta">@JaversSpringDataAuditable</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DocumentRepository</span> <span class="keyword">extends</span> <span class="title">MongoRepository</span>&lt;<span class="title">Document</span>,<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>document的版本记录效果如下：</p>
<img src="http://cdn.nemoworks.info/devlog.nju-cvicse.cn/images/document_javers.png">

<h4 id="删除document"><a href="#删除document" class="headerlink" title="删除document"></a>删除document</h4><p>document中删除操作与schema相同，即修改status属性为Deleted，以备后续需要时进行查看，接口如下：</p>
<p>service层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteDocument</span><span class="params">(String id,String collectionName)</span></span>&#123;</span><br><span class="line">  Document document1 = <span class="keyword">this</span>.getDocumentByIdAndCollectionName(id,collectionName);</span><br><span class="line">  document1.setStatus(Status.Deleted);</span><br><span class="line">  mongoTemplate.save(document1,collectionName);</span><br><span class="line">  documentRepository.save(document1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>controller层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Document&gt; <span class="title">deleteDocument</span><span class="params">(@PathVariable String id, @RequestParam(value = <span class="string">"collectionName"</span>,defaultValue = <span class="string">"null"</span>)</span> String collectionName)</span>&#123;</span><br><span class="line">  logger.info(<span class="string">"delete document "</span>+id);</span><br><span class="line">  <span class="keyword">this</span>.documentService.deleteDocument(id,collectionName);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.documentService.getAllDocumentsByCollectionName(collectionName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="更新document"><a href="#更新document" class="headerlink" title="更新document"></a>更新document</h4><p>更新document时由于数据发生变化，JaVers会记录修改内容，实现版本维护，接口如下：</p>
<p>service层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Document <span class="title">updateDocument</span><span class="params">(String id,String collectionName,JSONObject content)</span></span>&#123;</span><br><span class="line">  logger.info(<span class="string">"update document by id."</span>);</span><br><span class="line">  <span class="keyword">this</span>.documentRepository.findById(id).ifPresent(document -&gt; &#123;</span><br><span class="line">    document.setData(content);</span><br><span class="line">    <span class="keyword">this</span>.documentRepository.save(document);</span><br><span class="line">  &#125;);</span><br><span class="line">  Document document = <span class="keyword">this</span>.getDocumentByIdAndCollectionName(id,collectionName);</span><br><span class="line">  document.setData(content);</span><br><span class="line">  <span class="keyword">return</span> mongoTemplate.save(document,collectionName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>controller层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Document <span class="title">updateDocument</span><span class="params">(@PathVariable String id,@RequestParam(value = <span class="string">"collectionName"</span>,defaultValue = <span class="string">"null"</span>)</span>String collectionName,@RequestBody JSONObject params)</span>&#123;</span><br><span class="line">  logger.info(<span class="string">"update document by Id "</span>+ id+<span class="string">" and collectionName "</span>+collectionName);</span><br><span class="line">  <span class="keyword">return</span> documentService.updateDocument(id,collectionName,params);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="查询document（后台接口）"><a href="#查询document（后台接口）" class="headerlink" title="查询document（后台接口）"></a>查询document（后台接口）</h4><p>获取某个类型的所有未被删除的document：</p>
<p>service层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Document&gt; <span class="title">getAllDocumentsByCollectionName</span><span class="params">(String collectionName)</span></span>&#123;</span><br><span class="line">  logger.info(<span class="string">"get all documents by collectionName."</span>);</span><br><span class="line">  Query query = <span class="keyword">new</span> Query();</span><br><span class="line">  query.addCriteria(Criteria.where(<span class="string">"status"</span>).is(Status.Created));</span><br><span class="line">  <span class="keyword">return</span> mongoTemplate.find(query,Document.class,collectionName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>controller层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Document&gt; <span class="title">getDocuments</span><span class="params">(@RequestParam(value = <span class="string">"collectionName"</span>,defaultValue = <span class="string">"null"</span>)</span>String collectionName)</span>&#123;</span><br><span class="line">  logger.info(<span class="string">"get all documents by collectionName "</span>+collectionName);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.documentService.getAllDocumentsByCollectionName(collectionName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在某个类型的document中根据id检索：</p>
<p>service层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Document <span class="title">getDocumentByIdAndCollectionName</span><span class="params">(String id,String collectionName)</span></span>&#123;</span><br><span class="line">  logger.info(<span class="string">"get document by id and collectionName"</span>+id);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.mongoTemplate.findOne(<span class="keyword">new</span> Query(Criteria.where(<span class="string">"_id"</span>).is(id)),Document.class,collectionName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>controller层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Document <span class="title">getDocumentByIdAndCollectionName</span><span class="params">(@PathVariable String id,@RequestParam(value = <span class="string">"collectionName"</span>,defaultValue = <span class="string">"null"</span>)</span>String collectionName)</span>&#123;</span><br><span class="line">  logger.info(<span class="string">"get document by id "</span>+id+<span class="string">" and collectionName "</span>+collectionName);</span><br><span class="line">  <span class="keyword">return</span> documentService.getDocumentByIdAndCollectionName(id,collectionName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据documentId和javers记录的提交编号检索对应document的历史版本：</p>
<p>service层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Document <span class="title">getDocumentWithJaversCommitId</span><span class="params">(String documentId, String commitId)</span></span>&#123;</span><br><span class="line">  Document document = <span class="keyword">this</span>.documentRepository.findById(documentId).get();</span><br><span class="line">  JqlQuery jqlQuery = QueryBuilder.byInstance(document).build();</span><br><span class="line">  List&lt;CdoSnapshot&gt; snapshots = javers.findSnapshots(jqlQuery);</span><br><span class="line">  <span class="keyword">for</span> (CdoSnapshot snapshot : snapshots) &#123;</span><br><span class="line">    <span class="keyword">if</span> (snapshot.getCommitId().getMajorId() == Integer.parseInt(commitId))</span><br><span class="line">      <span class="keyword">return</span> JSON.parseObject(javers.getJsonConverter().toJson(snapshot.getState()), Document.class);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>controller层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> JSONArray <span class="title">getDocumentWithCommitId</span><span class="params">(@PathVariable String id,@RequestParam(value = <span class="string">"commitId"</span>, defaultValue = <span class="string">"null"</span>)</span> String commitId) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (commitId.equals(<span class="string">"null"</span>)) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      logger.info(<span class="string">"Get Document commits with documentId "</span>+ id);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.documentService.trackDocumentChangesWithJavers(id);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ResponseStatusException(HttpStatus.NOT_FOUND, <span class="string">"Document Not Found."</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      logger.info(<span class="string">"Cet Document commit with commitId"</span> + commitId);</span><br><span class="line">      JSONArray jsonArray = <span class="keyword">new</span> JSONArray();</span><br><span class="line">      jsonArray.add(<span class="keyword">this</span>.documentService.getDocumentWithJaversCommitId(id, commitId));</span><br><span class="line">      <span class="keyword">return</span> jsonArray;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ResponseStatusException(HttpStatus.NOT_FOUND, <span class="string">"Document Not Found."</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关联（聚合）查询，根据document中记录的对应link访问到其他document：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Document <span class="title">getCompleteDocument</span><span class="params">(String id, String collectionName, JSONArray filterFactors)</span></span>&#123;</span><br><span class="line">  logger.info(<span class="string">"get document by id "</span>+id);</span><br><span class="line">  List&lt;AggregationOperation&gt; operations = Lists.newArrayList();</span><br><span class="line">  operations.add(Aggregation.match(Criteria.where(<span class="string">"_id"</span>).is(id)));</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;filterFactors.size();i++)&#123;</span><br><span class="line">    JSONObject filterFactor = filterFactors.getJSONObject(i);</span><br><span class="line">    LookupOperation lookupOperation = LookupOperation.newLookup()</span><br><span class="line">      .from(filterFactor.getString(<span class="string">"collectionName"</span>))</span><br><span class="line">      .localField(filterFactor.getString(<span class="string">"localParam"</span>))</span><br><span class="line">      .foreignField(filterFactor.getString(<span class="string">"foreignParam"</span>))</span><br><span class="line">      .as(filterFactor.getString(<span class="string">"localParam"</span>));</span><br><span class="line">    operations.add(lookupOperation);</span><br><span class="line">  &#125;</span><br><span class="line">  Aggregation aggregation = Aggregation.newAggregation(operations);</span><br><span class="line">  AggregationResults&lt;Document&gt; contractAggregationResults= mongoTemplate.aggregate(aggregation,collectionName, Document.class);</span><br><span class="line">  List&lt;Document&gt; documents = contractAggregationResults.getMappedResults();</span><br><span class="line">  <span class="keyword">if</span>(documents.size()==<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> documents.get(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="数据渲染"><a href="#数据渲染" class="headerlink" title="数据渲染"></a>数据渲染</h3><h4 id="富文本渲染"><a href="#富文本渲染" class="headerlink" title="富文本渲染"></a>富文本渲染</h4><p>项目中使用<a href="https://braft.margox.cn/" target="_blank" rel="noopener">Braft Editor</a>来实现合同文档的在线编辑。Braft Editor是基于<a href="https://draftjs.org/" target="_blank" rel="noopener">draft-js</a>开发的富文本编辑器，支持value和onChange属性，内部使用EditorState对象作为数据格式，可以用典型的受控组件的形式来使用：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="comment">// 引入编辑器组件</span></span><br><span class="line"><span class="keyword">import</span> BraftEditor <span class="keyword">from</span> <span class="string">'braft-editor'</span></span><br><span class="line"><span class="comment">// 引入编辑器样式</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'braft-editor/dist/index.css'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">EditorDemo</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    state = &#123;</span><br><span class="line">        <span class="comment">// 创建一个空的editorState作为初始值</span></span><br><span class="line">      	<span class="comment">// createEditorState的参数可以是HTML，也可以是JSON</span></span><br><span class="line">        editorState: BraftEditor.createEditorState(<span class="literal">null</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    submitContent = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 在编辑器获得焦点时按下ctrl+s会执行此方法</span></span><br><span class="line">        <span class="comment">// 编辑器内容提交到服务端之前，可直接调用editorState.toHTML()来获取HTML格式的内容</span></span><br><span class="line">        <span class="keyword">const</span> htmlContent = <span class="keyword">this</span>.state.editorState.toHTML()</span><br><span class="line">        <span class="keyword">const</span> result = <span class="keyword">await</span> saveEditorContent(htmlContent)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    handleEditorChange = <span class="function">(<span class="params">editorState</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.setState(&#123; editorState &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    render () &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; editorState &#125; = <span class="keyword">this</span>.state</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">                &lt;BraftEditor</span><br><span class="line">                    value=&#123;editorState&#125;</span><br><span class="line">                    onChange=&#123;<span class="keyword">this</span>.handleEditorChange&#125;</span><br><span class="line">                    onSave=&#123;<span class="keyword">this</span>.submitContent&#125;</span><br><span class="line">                /&gt;</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不过EditorState对象无法用于展示也无法用于持久化存储，所以想把编辑器内容存进数据库就需要进行如下的数据转换：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> rawString = editorState.toRAW()</span><br><span class="line"><span class="comment">// editorState.toRAW()方法接收一个布尔值参数，用于决定是否返回RAW JSON对象，默认是false</span></span><br><span class="line"><span class="keyword">const</span> rawJSON = editorState.toRAW(<span class="literal">true</span>)</span><br><span class="line"><span class="comment">// 将editorState数据转换成html字符串</span></span><br><span class="line"><span class="keyword">const</span> htmlString = editorState.toHTML()</span><br></pre></td></tr></table></figure>

<p>占位符定义</p>
<p>合同中使用占位符来将合同内容和schema表单联系起来，当表单项填入了具体数值，合同中的占位符会被对应的数字替换。</p>
<ul>
<li>简单占位符</li>
</ul>
<p>json schema editor中原生的string、number、boolean、integer类型对应的占位符格式定义为<code>${/* label */}</code>。具体例子如下，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JSON schema</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"sample"</span>: &#123;</span><br><span class="line">    <span class="string">"type"</span>: <span class="string">"string"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 占位符</span></span><br><span class="line">$&#123;sample&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>表格占位符</li>
</ul>
<p>由于array类型需要转换为表格，所以它有特殊的占位符格式，定义为<code>$[/* label */]</code>，此外，表格占位符需独占一行。具体例子如下，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JSON schema</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"sample"</span>: &#123;</span><br><span class="line">    <span class="string">"type"</span>: <span class="string">"array"</span>,</span><br><span class="line">    <span class="string">"item"</span>: &#123;</span><br><span class="line">      <span class="string">"type"</span>: <span class="string">"string"</span></span><br><span class="line">  	&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 占位符</span></span><br><span class="line">$[sample]</span><br></pre></td></tr></table></figure>

<p>占位符替换</p>
<p>在Braft Editor中，文本以block的形式存于Editor State中，所以先用json path对Editor State的所有block的文本内容进行查找，通过正则表达式匹配出符合定义的占位符，再根据不同的占位符类型进行替换。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">getEditorState</span>(<span class="params">&#123; editorContent, formData &#125;</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 深拷贝editorContent */</span></span><br><span class="line">  <span class="keyword">let</span> copyContent = <span class="built_in">JSON</span>.parse(<span class="built_in">JSON</span>.stringify(editorContent))</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 占位符正则表达式 */</span></span><br><span class="line">  <span class="keyword">const</span> fieldRE = <span class="regexp">/(?:\$\&#123;)(\w+)(?:\&#125;)/g</span></span><br><span class="line">  <span class="keyword">const</span> arrayRE = <span class="regexp">/(?:\$\[)(\w+)(?:\])/</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 查找并替换copyContent中的目标字段，替换规则见formDataParser */</span></span><br><span class="line">  jp.apply(copyContent, <span class="string">'$..blocks[?(@.text)].text'</span>, text =&gt; text.replace(fieldRE, (_, field) =&gt; formDataParser(formData, field)))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> preState = BraftEditor.createEditorState(copyContent)</span><br><span class="line">  </span><br><span class="line">  jp.apply(copyContent, <span class="string">'$..blocks[?(@.text)]'</span>, block =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> match = block.text.match(arrayRE)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (match &amp;&amp; formData[match[<span class="number">1</span>]]) &#123;</span><br><span class="line">      <span class="keyword">let</span> data = formData[match[<span class="number">1</span>]]</span><br><span class="line">      preState = replacePlaceholder(preState, block.key, data.map(<span class="function"><span class="params">row</span> =&gt;</span> <span class="built_in">Object</span>.keys(row).map(<span class="function"><span class="params">col</span> =&gt;</span> row[col])))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> block</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> preState</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>替换简单占位符</li>
</ul>
<p>用replace方法直接将占位符替换成对应的数值；如果数值不合法，会对错误进行标识。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> formDataParser = <span class="function">(<span class="params">formData, field</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> data = formData[field]</span><br><span class="line">  <span class="keyword">return</span> data &amp;&amp; <span class="keyword">typeof</span> (data) !== <span class="string">'object'</span> ? formData[field] : <span class="string">`「<span class="subst">$&#123;field&#125;</span> error」`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>替换表格占位符</li>
</ul>
<p>通过正则表达式找到包含表格占位符的block，再按二维数组的大小插入空表格，最后将数值按顺序填入表格中，最后将占位符block删去。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将数值填入block</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fillBlock</span>(<span class="params">editorState, raw</span>) </span>&#123; </span><br><span class="line">  <span class="keyword">let</span> newContentState;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> text = <span class="built_in">String</span>(raw)</span><br><span class="line">    <span class="keyword">if</span> (text === <span class="string">"undefined"</span> || text === <span class="string">"null"</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="string">"error"</span></span><br><span class="line">    &#125;</span><br><span class="line">    newContentState = Modifier.replaceText(editorState.getCurrentContent(), editorState.getSelection(), text)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    newContentState = editorState.getCurrentContent()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ContentUtils.createEditorState(newContentState)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 替换表格占位符</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">replacePlaceholder</span>(<span class="params">editorState, blockKey, data</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> blockState;</span><br><span class="line">	<span class="comment">// 表格行列数</span></span><br><span class="line">  <span class="keyword">const</span> row = data.length</span><br><span class="line">  <span class="keyword">const</span> col = data[<span class="number">0</span>].length</span><br><span class="line">	<span class="comment">// 找到包含表格占位符的block</span></span><br><span class="line">  <span class="keyword">try</span> &#123; blockState = editorState.getCurrentContent().getBlockForKey(blockKey); &#125;</span><br><span class="line">  <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'no such block'</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> block = blockState;</span><br><span class="line">  <span class="comment">// 把光标定位到该block</span></span><br><span class="line">  <span class="keyword">let</span> newEditorState = ContentUtils.selectBlock(editorState, block);</span><br><span class="line">  <span class="comment">// 在该block之后插入空表格</span></span><br><span class="line">  newEditorState = TableUtils.insertTable(newEditorState, col, row);</span><br><span class="line">  <span class="comment">// 插入表格后光标定位到表格第一格</span></span><br><span class="line">  <span class="keyword">let</span> selectionBlock = ContentUtils.getSelectionBlock(newEditorState)</span><br><span class="line">  <span class="keyword">while</span> (selectionBlock.getType() !== <span class="string">'table-cell'</span>) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'next'</span>)</span><br><span class="line">    newEditorState = ContentUtils.selectNextBlock(newEditorState, selectionBlock)</span><br><span class="line">    selectionBlock = ContentUtils.getSelectionBlock(newEditorState)</span><br><span class="line">  &#125;</span><br><span class="line">	<span class="comment">// 填入数值</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; row; i += <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> j = <span class="number">0</span>; j &lt; col; j += <span class="number">1</span>) &#123;</span><br><span class="line">      newEditorState = fillBlock(newEditorState, data[i][j])</span><br><span class="line">      newEditorState = ContentUtils.selectNextBlock(newEditorState, selectionBlock)</span><br><span class="line">      selectionBlock = ContentUtils.getSelectionBlock(newEditorState)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 删除占位符block</span></span><br><span class="line">  newEditorState = ContentUtils.removeBlock(newEditorState, block)</span><br><span class="line">  <span class="keyword">return</span> newEditorState;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="chart"><a href="#chart" class="headerlink" title="chart"></a>chart</h4><p>（报表）从外部Excel导入数据，分析后生成charts</p>
<h4 id="spread-sheet"><a href="#spread-sheet" class="headerlink" title="spread sheet"></a>spread sheet</h4><h3 id="流程管理"><a href="#流程管理" class="headerlink" title="流程管理"></a>流程管理</h3><p>每个task都可以关联一个schema 将schema具体内容放入formporperty中</p>
<p>研究task的具体生命周期</p>

        </div>

        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
            
            <a class="next" rel="next" href="/Leasing/Project/">项目进展</a>
            
        </section>


    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© Old Cao | Powered by <a href="https://hexo.io" target="_blank">Hexo</a></span>
    </div>
</footer>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-145118419-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-145118419-1');
</script>

    </div>
</body>
</html>
